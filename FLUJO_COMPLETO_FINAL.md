# Flujo de Negocio Completo - Plataforma de Profesionales

## Fecha: Octubre 7, 2025

## üìã Resumen Ejecutivo

Este documento describe el flujo completo del negocio desde el registro del profesional hasta la finalizaci√≥n de una consulta con un cliente. **NO incluye funcionalidad de chat** - la comunicaci√≥n es √∫nicamente a trav√©s de videollamadas.

---

## üîÑ Flujo Completo del Negocio

### PASO 1: Registro y Validaci√≥n de Profesional ‚úÖ

**Estado**: IMPLEMENTADO

1. Profesional se registra en la plataforma
2. Recibe email de confirmaci√≥n
3. Valida su email haciendo click en el link
4. Usuario activo creado con rol `PROFESSIONAL`

**Endpoints**:

- `POST /auth/register` - Registro inicial
- `POST /auth/verify-email` - Validaci√≥n de email

**Esquema**:

```prisma
model User {
  email: string @unique
  password: string (hashed)
  role: Role (PROFESSIONAL)
  isEmailVerified: boolean
  emailVerificationToken: string?
}
```

---

### PASO 2: Creaci√≥n de Perfil Profesional ‚úÖ

**Estado**: IMPLEMENTADO

1. Profesional completa su perfil con:
   - Bio y descripci√≥n
   - Categor√≠a de servicio
   - Precio por sesi√≥n (`pricePerSession`)
   - Duraci√≥n est√°ndar de consulta
   - Ubicaci√≥n y tags
2. Perfil creado con estado `isActive: true`

**Endpoints**:

- `POST /profiles` - Crear perfil profesional
- `PUT /profiles/me` - Actualizar perfil

**Esquema**:

```prisma
model ProfessionalProfile {
  userId: string @unique
  pricePerSession: Decimal
  standardDuration: int
  serviceCategoryId: string
  isVerified: boolean @default(false)
  isActive: boolean @default(true)
  mercadoPagoEmail: string?      // ‚ú® NUEVO
  mercadoPagoUserId: string?     // ‚ú® NUEVO
  mpConfiguredAt: DateTime?      // ‚ú® NUEVO
}
```

---

### PASO 3: Configuraci√≥n de MercadoPago ‚úÖ

**Estado**: IMPLEMENTADO

1. Profesional configura sus credenciales de MercadoPago:
   - Email de cuenta MP
   - (Opcional) User ID de MP para futura distribuci√≥n
2. Se guarda fecha de configuraci√≥n (`mpConfiguredAt`)

**Endpoints**:

- `PUT /profiles/me/mercadopago` - Configurar credenciales MP
- `GET /profiles/me/mercadopago` - Consultar configuraci√≥n

**Respuesta**:

```json
{
  "success": true,
  "mercadoPagoEmail": "profesional@example.com",
  "configuredAt": "2025-10-07T16:00:00Z",
  "message": "Configuraci√≥n guardada exitosamente"
}
```

---

### PASO 4: Listado de Profesionales ‚úÖ

**Estado**: IMPLEMENTADO

1. Cliente busca profesionales por:
   - Categor√≠a de servicio
   - Ubicaci√≥n
   - Tags/especializaci√≥n
   - Precio
2. Sistema retorna profesionales activos y verificados
3. Cliente puede ver perfil completo, precio y disponibilidad

**Endpoints**:

- `GET /search/professionals?category=...&location=...`
- `GET /profiles/:id` - Ver perfil espec√≠fico

---

### PASO 5: Solicitud y Pago de Consulta ‚úÖ

**Estado**: IMPLEMENTADO COMPLETAMENTE

#### 5.1 Cliente Solicita Consulta

1. Cliente selecciona profesional y horario
2. Se crea `Booking` con estado `PENDING_PAYMENT`
3. Se genera sala Jitsi √∫nica: `{professionalId-uuid}`

**Endpoint**:

```
POST /bookings
{
  "professionalId": "uuid",
  "scheduledAt": "2025-10-08T15:00:00Z",
  "duration": 60,
  "notes": "Consulta sobre..."
}
```

#### 5.2 Cliente Paga la Consulta ‚ú® NUEVO

1. Cliente solicita crear pago para booking:

   ```
   POST /bookings/:bookingId/payment
   ```

2. Sistema:
   - Valida que booking existe y pertenece al cliente
   - Verifica estado `PENDING_PAYMENT`
   - Crea MercadoPago preference con:
     - `external_reference`: bookingId
     - `amount`: pricePerSession del profesional
     - `payer`: datos del cliente
     - `metadata`: { bookingId, professionalId, clientId }
   - Crea registro `Payment` vinculado a `Booking`
   - Retorna `init_point` para checkout

3. Cliente es redirigido a MercadoPago checkout

**Respuesta**:

```json
{
  "paymentId": "uuid",
  "preferenceId": "mp-preference-id",
  "init_point": "https://www.mercadopago.com.ar/checkout/...",
  "amount": 5000,
  "bookingId": "uuid"
}
```

#### 5.3 Configuraci√≥n de Pago (Plataforma)

- **Tipo**: Pago 100% a plataforma (NO split payment)
- **Raz√≥n**: Simplificaci√≥n, control de fondos
- **Futuro**: Distribuci√≥n manual o autom√°tica usando `mercadoPagoUserId`
- **Metadata**: Se rastrea `professionalId` para auditor√≠a

---

### PASO 6: Webhook y Notificaci√≥n al Profesional ‚úÖ

**Estado**: IMPLEMENTADO COMPLETAMENTE

#### 6.1 MercadoPago Webhook

1. MP env√≠a notificaci√≥n cuando pago es aprobado:

   ```
   POST /payments/webhook
   {
     "type": "payment",
     "data": { "id": "payment-id" }
   }
   ```

2. Sistema procesa webhook:
   - Obtiene payment de MP usando `data.id`
   - Extrae `external_reference` (bookingId)
   - Encuentra booking asociado
   - Actualiza `Payment.status` a `COMPLETED`
   - **Actualiza `Booking.status` a `WAITING_FOR_PROFESSIONAL`** ‚ú®
   - Crea **notificaci√≥n** para el profesional ‚ú®

#### 6.2 Notificaci√≥n Creada

```json
{
  "userId": "professional-user-id",
  "type": "BOOKING_REQUEST",
  "title": "Nueva solicitud de consulta",
  "message": "Tienes una nueva solicitud de consulta pagada. El cliente ya realiz√≥ el pago de $5000.",
  "payload": {
    "bookingId": "uuid",
    "amount": "5000",
    "paymentId": "uuid",
    "clientId": "uuid"
  }
}
```

**Endpoints de Notificaciones** ‚ú® NUEVO:

- `GET /notifications` - Listar notificaciones
- `GET /notifications/unread` - Solo no le√≠das
- `GET /notifications/unread/count` - Contador
- `PATCH /notifications/:id/read` - Marcar como le√≠da
- `PATCH /notifications/read-all` - Marcar todas
- `DELETE /notifications/:id` - Eliminar

---

### PASO 7: Profesional Acepta/Rechaza Consulta ‚úÖ

**Estado**: IMPLEMENTADO

1. Profesional recibe notificaci√≥n (in-app)
2. Revisa detalles de la consulta
3. Decide aceptar o rechazar

**Si Acepta**:

- `Booking.status` ‚Üí `CONFIRMED`
- `Booking.meetingStatus` ‚Üí `WAITING`
- Cliente recibe notificaci√≥n de confirmaci√≥n

**Si Rechaza**:

- `Booking.status` ‚Üí `CANCELLED`
- Sistema procesa reembolso (manual por ahora)

**Endpoints**:

- `PATCH /bookings/:id/accept` - Aceptar consulta
- `PATCH /bookings/:id/reject` - Rechazar consulta

---

### PASO 8: Videollamada (SIN CHAT) ‚úÖ

**Estado**: IMPLEMENTADO (Sin funcionalidad de chat)

#### 8.1 Inicio de Videollamada

1. A la hora programada, profesional y cliente ingresan a sala Jitsi
2. Profesional inicia la reuni√≥n:
   ```
   POST /bookings/:id/start
   ```
3. Sistema:
   - Actualiza `meetingStatus` ‚Üí `ACTIVE`
   - Guarda `meetingStartTime`
   - Configura timer de 18 minutos

#### 8.2 Durante la Videollamada

- **Comunicaci√≥n**: Solo video/audio (NO chat)
- **Funcionalidades Jitsi**:
  - Video bidireccional ‚úÖ
  - Audio ‚úÖ
  - Compartir pantalla ‚úÖ
  - Grabaci√≥n (si configurado) ‚úÖ
  - Chat integrado ‚ùå DESHABILITADO
  - Lobby chat ‚ùå DESHABILITADO

#### 8.3 Finalizaci√≥n

1. Timer alcanza 18 minutos o profesional finaliza manualmente
2. Sistema:
   - Cierra sala Jitsi
   - Actualiza `meetingStatus` ‚Üí `COMPLETED`
   - Actualiza `Booking.status` ‚Üí `COMPLETED`
   - Guarda `meetingEndTime`

**Endpoints**:

- `POST /bookings/:id/start` - Iniciar reuni√≥n
- `POST /bookings/:id/complete` - Finalizar reuni√≥n

**Configuraci√≥n Jitsi**:

```typescript
{
  enableLobbyChat: false,          // ‚ùå Chat de lobby deshabilitado
  toolbarButtons: [
    'microphone',
    'camera',
    'desktop',
    'fullscreen',
    'settings'
    // NO incluye 'chat'
  ]
}
```

---

## üìä Estados del Sistema

### BookingStatus

```
PENDING_PAYMENT              ‚Üí Cliente cre√≥ booking, esperando pago
WAITING_FOR_PROFESSIONAL     ‚Üí Pago aprobado, esperando aceptaci√≥n ‚ú® NUEVO
PENDING                      ‚Üí Profesional acept√≥ (legacy)
CONFIRMED                    ‚Üí Confirmado, listo para reuni√≥n
IN_PROGRESS                  ‚Üí Reuni√≥n en curso
COMPLETED                    ‚Üí Reuni√≥n finalizada
CANCELLED                    ‚Üí Cancelado
NO_SHOW                      ‚Üí Cliente no se present√≥
```

### PaymentStatus

```
PENDING        ‚Üí Pago iniciado, esperando confirmaci√≥n
COMPLETED      ‚Üí Pago aprobado
FAILED         ‚Üí Pago rechazado/fallido
```

### MeetingStatus

```
PENDING        ‚Üí Antes del pago
WAITING        ‚Üí Cliente pag√≥, esperando aceptaci√≥n
ACTIVE         ‚Üí Reuni√≥n en curso
COMPLETED      ‚Üí Reuni√≥n finalizada
CANCELLED      ‚Üí Reuni√≥n cancelada
EXPIRED        ‚Üí Tiempo de espera agotado
```

### NotificationType ‚ú® NUEVO

```
BOOKING_REQUEST      ‚Üí Nueva solicitud de consulta (pago aprobado)
BOOKING_CONFIRMED    ‚Üí Consulta confirmada
BOOKING_CANCELLED    ‚Üí Consulta cancelada
PAYMENT_RECEIVED     ‚Üí Pago recibido
REVIEW_RECEIVED      ‚Üí Rese√±a recibida
SYSTEM_NOTIFICATION  ‚Üí Notificaci√≥n del sistema
```

---

## üîó Relaciones de Modelos

```
User (1) ‚îÄ‚îÄ‚Üí (1) ProfessionalProfile
User (1) ‚îÄ‚îÄ‚Üí (N) Booking [as client]
ProfessionalProfile (1) ‚îÄ‚îÄ‚Üí (N) Booking [as professional]
Booking (1) ‚îÄ‚îÄ‚Üí (1) Payment
Payment (1) ‚îÄ‚îÄ‚Üí (N) PaymentEvent
User (1) ‚îÄ‚îÄ‚Üí (N) Notification ‚ú®
```

**Relaci√≥n Payment ‚Üî Booking**:

- `Booking.paymentId` ‚Üí `Payment.id` (FK √∫nica)
- Permite: `booking.payment` y `payment.booking`

---

## üöÄ APIs Implementadas

### Autenticaci√≥n

- ‚úÖ POST /auth/register
- ‚úÖ POST /auth/login
- ‚úÖ POST /auth/verify-email
- ‚úÖ POST /auth/forgot-password
- ‚úÖ POST /auth/reset-password

### Perfiles

- ‚úÖ POST /profiles
- ‚úÖ PUT /profiles/me
- ‚úÖ GET /profiles/me
- ‚úÖ GET /profiles/:id
- ‚úÖ PUT /profiles/me/mercadopago ‚ú®
- ‚úÖ GET /profiles/me/mercadopago ‚ú®

### B√∫squeda

- ‚úÖ GET /search/professionals

### Bookings

- ‚úÖ POST /bookings
- ‚úÖ GET /bookings (mis bookings)
- ‚úÖ GET /bookings/:id
- ‚úÖ PATCH /bookings/:id/accept
- ‚úÖ PATCH /bookings/:id/reject
- ‚úÖ POST /bookings/:id/start
- ‚úÖ POST /bookings/:id/complete
- ‚úÖ POST /bookings/:id/payment ‚ú® NUEVO

### Pagos

- ‚úÖ POST /payments/webhook (MercadoPago)
- ‚úÖ GET /payments/:id

### Notificaciones ‚ú® NUEVO

- ‚úÖ GET /notifications
- ‚úÖ GET /notifications/unread
- ‚úÖ GET /notifications/unread/count
- ‚úÖ PATCH /notifications/:id/read
- ‚úÖ PATCH /notifications/read-all
- ‚úÖ DELETE /notifications/:id

---

## ‚ö° Flujo de Eventos

```mermaid
sequenceDiagram
    participant C as Cliente
    participant S as Sistema
    participant MP as MercadoPago
    participant P as Profesional

    C->>S: POST /bookings (crea booking)
    S-->>C: booking creado (PENDING_PAYMENT)

    C->>S: POST /bookings/:id/payment
    S->>MP: createPreference()
    MP-->>S: preference.init_point
    S-->>C: redirect to checkout

    C->>MP: Completa pago
    MP->>S: Webhook (payment.approved)
    S->>S: Update booking ‚Üí WAITING_FOR_PROFESSIONAL
    S->>S: Create notification for professional
    S-->>P: Notificaci√≥n in-app

    P->>S: GET /notifications/unread
    S-->>P: Lista de notificaciones

    P->>S: PATCH /bookings/:id/accept
    S-->>P: booking confirmado
    S-->>C: Notificaci√≥n de confirmaci√≥n

    Note over C,P: Hora de la consulta

    P->>S: POST /bookings/:id/start
    S-->>C: Reuni√≥n iniciada

    Note over C,P: Videollamada 18 min (NO chat)

    P->>S: POST /bookings/:id/complete
    S-->>C: Reuni√≥n finalizada
```

---

## üéØ Decisiones T√©cnicas Clave

### 1. **Pago 100% a Plataforma**

- ‚úÖ Simplifica integraci√≥n inicial
- ‚úÖ Control total de fondos
- ‚úÖ Facilita contabilidad
- üìù Metadata guarda `professionalId` para distribuci√≥n futura
- üîÆ Futuro: Usar `mercadoPagoUserId` para split autom√°tico

### 2. **Sin Funcionalidad de Chat**

- ‚ùå Chat eliminado completamente del sistema
- ‚úÖ Comunicaci√≥n √∫nicamente por videollamada
- ‚úÖ Simplifica arquitectura (no WebSocket/Socket.IO)
- ‚úÖ Reduce costos de infraestructura
- ‚úÖ Mejor para consultas profesionales en tiempo real

### 3. **external_reference = bookingId**

- ‚úÖ Vincula webhook de MP con booking espec√≠fico
- ‚úÖ Permite actualizaci√≥n autom√°tica de estado
- ‚úÖ Trazabilidad completa pago ‚Üí booking

### 4. **Notificaciones In-App**

- ‚úÖ Almacenadas en DB (tabla `Notification`)
- ‚úÖ APIs REST para consulta
- ‚úÖ Contador de no le√≠das
- üìß Futuro: Agregar email notifications
- üîî Futuro: Agregar push notifications

---

## üìà M√©tricas y Observabilidad

### Logs Importantes

```typescript
// PaymentsService
"üîî Processing MP webhook";
"‚úÖ Booking updated to WAITING_FOR_PROFESSIONAL";
"‚úÖ Notification created for professional";

// BookingsService
"üí∞ Creating payment for booking";
"‚úÖ Payment created successfully";
"üé• Meeting started";
"‚úÖ Meeting completed";
```

### Eventos a Trackear

- ‚úÖ Pago creado
- ‚úÖ Pago aprobado (webhook)
- ‚úÖ Booking actualizado
- ‚úÖ Notificaci√≥n enviada
- ‚úÖ Profesional acepta/rechaza
- ‚úÖ Reuni√≥n iniciada/finalizada

---

## üîê Seguridad

### Autenticaci√≥n

- ‚úÖ JWT tokens
- ‚úÖ Password hashing (bcrypt)
- ‚úÖ Email verification

### Autorizaci√≥n

- ‚úÖ Role-based access (CLIENT, PROFESSIONAL, ADMIN)
- ‚úÖ Guards en endpoints cr√≠ticos
- ‚úÖ Verificaci√≥n de ownership (booking pertenece al cliente)

### Pagos

- ‚úÖ Webhook signature verification (MercadoPago)
- ‚úÖ Idempotency keys
- ‚úÖ Validaci√≥n de montos
- ‚úÖ Prevenci√≥n de pagos duplicados

---

## üìù Pr√≥ximos Pasos Sugeridos

### Corto Plazo

1. ‚úÖ ~~Implementar webhook ‚Üí booking update~~ COMPLETADO
2. ‚úÖ ~~Sistema de notificaciones in-app~~ COMPLETADO
3. üìß Email notifications (SendGrid/Resend)
4. üîî Push notifications (OneSignal/Firebase)

### Mediano Plazo

5. üí∞ Sistema de reembolsos autom√°tico
6. üìä Dashboard de analytics
7. ‚≠ê Sistema de reviews post-consulta
8. üìÖ Calendario de disponibilidad avanzado

### Largo Plazo

9. üåç Multi-moneda (BRL, MXN, CLP, etc.)
10. üí∏ Split payments autom√°tico con MP
11. üè¢ White-label para marcas
12. üì± Apps m√≥viles nativas

---

## üß™ Testing Checklist

### Flujo Completo

- [ ] Registro de profesional
- [ ] Validaci√≥n de email
- [ ] Creaci√≥n de perfil
- [ ] Configuraci√≥n de MP
- [ ] B√∫squeda de profesionales
- [ ] Creaci√≥n de booking
- [ ] Pago con MP (sandbox)
- [ ] Webhook recibido
- [ ] Booking actualizado
- [ ] Notificaci√≥n creada
- [ ] Profesional acepta
- [ ] Videollamada iniciada
- [ ] Videollamada finalizada

### Casos Edge

- [ ] Pago duplicado (debe fallar)
- [ ] Booking de otro cliente (debe fallar)
- [ ] Webhook con signature inv√°lido
- [ ] Pago rechazado
- [ ] Profesional rechaza consulta
- [ ] Cliente no se presenta (NO_SHOW)
- [ ] Timer de 18 min finaliza autom√°ticamente

---

## üìö Referencias

- [BUSINESS_FLOW_ANALYSIS.md](./BUSINESS_FLOW_ANALYSIS.md) - An√°lisis inicial
- [PAYMENT_BOOKING_INTEGRATION.md](./PAYMENT_BOOKING_INTEGRATION.md) - Integraci√≥n de pagos
- [MERCADOPAGO_INTEGRATION_REVIEW.md](./MERCADOPAGO_INTEGRATION_REVIEW.md) - Review de MP
- [CHAT_REMOVAL_SUMMARY.md](./CHAT_REMOVAL_SUMMARY.md) - Eliminaci√≥n de chat
- [AUTH_IMPLEMENTATION.md](./AUTH_IMPLEMENTATION.md) - Autenticaci√≥n

---

## ‚úÖ Estado Final

**Fecha**: Octubre 7, 2025  
**Estado**: IMPLEMENTACI√ìN COMPLETA  
**Versi√≥n**: 1.0

Todos los componentes cr√≠ticos del flujo de negocio est√°n implementados y funcionando:

- ‚úÖ Registro y autenticaci√≥n
- ‚úÖ Perfiles profesionales con MP
- ‚úÖ Sistema de bookings
- ‚úÖ Pagos integrados con MercadoPago
- ‚úÖ Webhook autom√°tico
- ‚úÖ Notificaciones in-app
- ‚úÖ Videollamadas sin chat
- ‚úÖ Gesti√≥n completa del ciclo de vida

**Ready for Production Testing** üöÄ
